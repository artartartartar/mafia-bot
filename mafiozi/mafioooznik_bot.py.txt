# -*- coding: utf-8 -*-
import asyncio
import logging
import random
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext

# ğŸ”‘ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜
BOT_TOKEN = "8276213136:AAGDPFrlROAdLsw2Bvxp9DteWHT2Pn2R0os"
CHANNEL_ID = "@mafiooooznik"  # â¬…ï¸ Ğ¢Ğ’ĞĞ™ ĞšĞĞĞĞ›

# ğŸ® Ğ¡ĞĞ—Ğ”ĞĞ•Ğœ Ğ‘ĞĞ¢Ğ
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# ğŸ¯ Ğ¥Ğ ĞĞĞ˜Ğ›Ğ˜Ğ©Ğ• Ğ”ĞĞĞĞ«Ğ¥
waiting_players = {}
active_game = None
player_votes = {}
night_actions = {}

# ğŸ¯ Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ¯ Ğ”Ğ›Ğ¯ ĞĞĞ§ĞĞ«Ğ¥ Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ™
class NightActions(StatesGroup):
    waiting_mafia = State()
    waiting_doctor = State()
    waiting_sheriff = State()

# ğŸ¯ ĞšĞ›ĞĞ¡Ğ¡ Ğ˜Ğ“Ğ Ğ«
class MafiaGame:
    def __init__(self):
        self.players = {}  # {user_id: {"name": "", "role": "", "alive": True}}
        self.phase = "night"  # night Ğ¸Ğ»Ğ¸ day
        self.day_number = 1
        self.mafia_target = None
        self.doctor_target = None
        self.sheriff_check = None
        self.votes = {}
        self.players_ready = set()
    
    def assign_roles(self, players_count):
        roles = []
        
        if players_count == 4:
            roles = ["mafia", "sheriff", "doctor", "civilian"]
        elif players_count == 5:
            roles = ["mafia", "sheriff", "doctor", "civilian", "civilian"]
        elif players_count == 6:
            roles = ["mafia", "mafia", "sheriff", "doctor", "civilian", "civilian"]
        elif players_count == 7:
            roles = ["mafia", "mafia", "sheriff", "doctor", "civilian", "civilian", "civilian"]
        elif players_count >= 8:
            mafia_count = players_count // 3
            roles = ["mafia"] * mafia_count + ["sheriff", "doctor"] + ["civilian"] * (players_count - mafia_count - 2)
            if len(roles) > players_count:
                roles = roles[:players_count]
        
        random.shuffle(roles)
        return roles
    
    async def send_roles(self):
        for user_id, player_info in self.players.items():
            role = player_info["role"]
            role_text = self.get_role_description(role)
            
            try:
                await bot.send_message(
                    user_id,
                    f"ğŸ­ Ğ¢Ğ’ĞĞ¯ Ğ ĞĞ›Ğ¬: {role_text}\n\n"
                    f"Ğ˜Ğ³Ñ€Ğ° Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ! Ğ¡Ğ»ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ° ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ¼ {CHANNEL_ID}"
                )
            except:
                print(f"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºÑƒ {player_info['name']}")
    
    def get_role_description(self, role):
        descriptions = {
            "mafia": "ğŸ”« ĞœĞĞ¤Ğ˜Ğ¯\nĞ¢Ñ‹ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑƒÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ²ÑĞµÑ… Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ñ… Ğ¶Ğ¸Ñ‚ĞµĞ»ĞµĞ¹! ĞĞ¾Ñ‡ÑŒÑ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°Ğ¹ Ğ¶ĞµÑ€Ñ‚Ğ²Ñƒ.",
            "sheriff": "ğŸ‘® Ğ¨Ğ•Ğ Ğ˜Ğ¤\nĞ¢Ñ‹ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¼Ğ°Ñ„Ğ¸Ñ! ĞĞ¾Ñ‡ÑŒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞ¹ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ².",
            "doctor": "ğŸ’‰ Ğ”ĞĞšĞ¢ĞĞ \nĞ¢Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ ÑĞ¿Ğ°ÑÑ‚Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ·Ğ° Ğ½Ğ¾Ñ‡ÑŒ!",
            "civilian": "ğŸ‘¨â€ğŸŒ¾ ĞœĞ˜Ğ ĞĞ«Ğ™ Ğ–Ğ˜Ğ¢Ğ•Ğ›Ğ¬\nĞĞ°Ğ¹Ğ´Ğ¸ Ğ¼Ğ°Ñ„Ğ¸Ñ Ğ¸ Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑÑƒĞ¹ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² Ğ½Ğ¸Ñ…!"
        }
        return descriptions.get(role, "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ñ€Ğ¾Ğ»ÑŒ")
    
    def get_alive_players(self):
        return [user_id for user_id, info in self.players.items() if info["alive"]]
    
    def get_alive_players_info(self):
        return {user_id: info for user_id, info in self.players.items() if info["alive"]}
    
    def check_win_condition(self):
        alive_players = self.get_alive_players_info()
        mafia_count = sum(1 for info in alive_players.values() if info["role"] == "mafia")
        civilian_count = len(alive_players) - mafia_count
        
        if mafia_count == 0:
            return "civilians"
        elif mafia_count >= civilian_count:
            return "mafia"
        return None
    
    async def start_night(self):
        self.phase = "night"
        self.players_ready.clear()
        night_actions.clear()
        
        # ĞĞ¿Ğ¾Ğ²ĞµÑ‰Ğ°ĞµĞ¼ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğµ
        await bot.send_message(
            CHANNEL_ID,
            f"ğŸŒ™ ĞĞĞ§Ğ¬ {self.day_number}\n\n"
            f"Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ·Ğ°ÑÑ‹Ğ¿Ğ°ĞµÑ‚...\n"
            f"ĞŸÑ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑ Ğ¼Ğ°Ñ„Ğ¸Ñ...\n"
            f"Ğ”Ğ¾ĞºÑ‚Ğ¾Ñ€ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ...\n"
            f"Ğ¨ĞµÑ€Ğ¸Ñ„ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ Ñ€Ğ°ÑÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ...\n\n"
            f"Ğ£ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² ĞµÑÑ‚ÑŒ 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ Ğ½Ğ° Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ!"
        )
        
        # Ğ Ğ°ÑÑÑ‹Ğ»Ğ°ĞµĞ¼ Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
        for user_id, player_info in self.get_alive_players_info().items():
            role = player_info["role"]
            
            if role == "mafia":
                await self.send_mafia_action(user_id)
            elif role == "doctor":
                await self.send_doctor_action(user_id)
            elif role == "sheriff":
                await self.send_sheriff_action(user_id)
    
    async def send_mafia_action(self, user_id):
        alive_players = self.get_alive_players_info()
        targets = {uid: info for uid, info in alive_players.items() if info["role"] != "mafia"}
        
        if not targets:
            return
            
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text=info["name"], callback_data=f"mafia_kill:{uid}")]
            for uid, info in targets.items()
        ])
        
        try:
            await bot.send_message(
                user_id,
                "ğŸ”« ĞœĞĞ¤Ğ˜Ğ¯, ĞŸĞ ĞĞ¡Ğ«ĞŸĞĞ™Ğ¢Ğ•Ğ¡Ğ¬!\n\n"
                "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ´Ğ»Ñ ÑƒÑÑ‚Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ:",
                reply_markup=keyboard
            )
        except:
            pass
    
    async def send_doctor_action(self, user_id):
        alive_players = self.get_alive_players_info()
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text=info["name"], callback_data=f"doctor_heal:{uid}")]
            for uid, info in alive_players.items()
        ])
        
        try:
            await bot.send_message(
                user_id,
                "ğŸ’‰ Ğ”ĞĞšĞ¢ĞĞ , ĞŸĞ ĞĞ¡Ğ«ĞŸĞĞ™Ğ¢Ğ•Ğ¡Ğ¬!\n\n"
                "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ´Ğ»Ñ Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ñ:",
                reply_markup=keyboard
            )
        except:
            pass
    
    async def send_sheriff_action(self, user_id):
        alive_players = self.get_alive_players_info()
        targets = {uid: info for uid, info in alive_players.items() if uid != user_id}
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text=info["name"], callback_data=f"sheriff_check:{uid}")]
            for uid, info in targets.items()
        ])
        
        try:
            await bot.send_message(
                user_id,
                "ğŸ‘® Ğ¨Ğ•Ğ Ğ˜Ğ¤, ĞŸĞ ĞĞ¡Ğ«ĞŸĞĞ™Ğ¡Ğ¯!\n\n"
                "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸:",
                reply_markup=keyboard
            )
        except:
            pass
    
    async def process_night_actions(self):
        # ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
        mafia_votes = {}
        doctor_votes = {}
        sheriff_votes = {}
        
        for action in night_actions.values():
            action_type, target_id = action
            if action_type == "mafia_kill":
                mafia_votes[target_id] = mafia_votes.get(target_id, 0) + 1
            elif action_type == "doctor_heal":
                doctor_votes[target_id] = doctor_votes.get(target_id, 0) + 1
            elif action_type == "sheriff_check":
                sheriff_votes[target_id] = sheriff_votes.get(target_id, 0) + 1
        
        # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ñ†ĞµĞ»Ğ¸
        self.mafia_target = max(mafia_votes.items(), key=lambda x: x[1])[0] if mafia_votes else None
        self.doctor_target = max(doctor_votes.items(), key=lambda x: x[1])[0] if doctor_votes else None
        self.sheriff_check = max(sheriff_votes.items(), key=lambda x: x[1])[0] if sheriff_votes else None
        
        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
        killed_player = None
        if self.mafia_target and self.mafia_target != self.doctor_target:
            self.players[self.mafia_target]["alive"] = False
            killed_player = self.players[self.mafia_target]["name"]
        
        # Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ÑˆĞµÑ€Ğ¸Ñ„Ğ°
        sheriff_result = None
        if self.sheriff_check:
            checked_role = self.players[self.sheriff_check]["role"]
            sheriff_result = "Ğ¼Ğ°Ñ„Ğ¸Ñ" if checked_role == "mafia" else "Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒ"
        
        # ĞĞ¿Ğ¾Ğ²ĞµÑ‰Ğ°ĞµĞ¼ Ğ¾ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°Ñ… Ğ½Ğ¾Ñ‡Ğ¸
        night_result = f"ğŸŒ™ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ« ĞĞĞ§Ğ˜ {self.day_number}:\n\n"
        
        if killed_player:
            night_result += f"â˜ ï¸ Ğ–ĞµÑ€Ñ‚Ğ²Ğ° Ğ¼Ğ°Ñ„Ğ¸Ğ¸: {killed_player}\n"
        else:
            night_result += "âœ… Ğ­Ñ‚Ğ¾Ğ¹ Ğ½Ğ¾Ñ‡ÑŒÑ Ğ½Ğ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ³Ğ¸Ğ±\n"
        
        # Ğ¡Ğ¾Ğ¾Ğ±Ñ‰Ğ°ĞµĞ¼ ÑˆĞµÑ€Ğ¸Ñ„Ñƒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
        sheriff_user_id = next((uid for uid, info in self.players.items() if info["role"] == "sheriff" and info["alive"]), None)
        if sheriff_user_id and sheriff_result:
            try:
                checked_name = self.players[self.sheriff_check]["name"]
                await bot.send_message(
                    sheriff_user_id,
                    f"ğŸ‘® Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜:\n\n"
                    f"Ğ˜Ğ³Ñ€Ğ¾Ğº {checked_name} - {sheriff_result}"
                )
            except:
                pass
        
        await bot.send_message(CHANNEL_ID, night_result)
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ğ¿Ğ¾Ğ±ĞµĞ´Ñ‹
        winner = self.check_win_condition()
        if winner:
            await self.end_game(winner)
            return False
        
        return True
    
    async def start_day(self):
        self.phase = "day"
        self.votes.clear()
        
        alive_players = self.get_alive_players_info()
        player_list = "\n".join([f"â€¢ {info['name']}" for info in alive_players.values()])
        
        await bot.send_message(
            CHANNEL_ID,
            f"â˜€ï¸ Ğ”Ğ•ĞĞ¬ {self.day_number}\n\n"
            f"Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ¿Ñ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑ...\n\n"
            f"ğŸ¯ Ğ–Ğ¸Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸ ({len(alive_players)}):\n{player_list}\n\n"
            f"ĞĞ±ÑÑƒĞ¶Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¸ Ğ³Ğ¾Ğ»Ğ¾ÑÑƒĞ¹Ñ‚Ğµ! Ğ£ Ğ²Ğ°Ñ 3 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹.\n"
            f"Ğ”Ğ»Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ: /vote @username"
        )
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²ÑĞµĞ¼ Ğ¶Ğ¸Ğ²Ñ‹Ğ¼ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°Ğ¼
        for user_id in alive_players.keys():
            await self.send_voting_keyboard(user_id)
    
    async def send_voting_keyboard(self, user_id):
        alive_players = self.get_alive_players_info()
        targets = {uid: info for uid, info in alive_players.items() if uid != user_id}
        
        if not targets:
            return
            
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text=info["name"], callback_data=f"vote:{uid}")]
            for uid, info in targets.items()
        ])
        
        try:
            await bot.send_message(
                user_id,
                "ğŸ—³ï¸ Ğ“ĞĞ›ĞĞ¡ĞĞ’ĞĞĞ˜Ğ•\n\nĞ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ´Ğ»Ñ Ğ¸Ğ·Ğ³Ğ½Ğ°Ğ½Ğ¸Ñ:",
                reply_markup=keyboard
            )
        except:
            pass
    
    async def process_voting(self):
        if not self.votes:
            await bot.send_message(CHANNEL_ID, "âŒ ĞĞ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ»!")
            return True
        
        # ĞŸĞ¾Ğ´ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ³Ğ¾Ğ»Ğ¾ÑĞ°
        vote_count = {}
        for target_id in self.votes.values():
            vote_count[target_id] = vote_count.get(target_id, 0) + 1
        
        # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ñ Ğ½Ğ°Ğ¸Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾Ğ¼ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²
        max_votes = max(vote_count.values())
        candidates = [target_id for target_id, votes in vote_count.items() if votes == max_votes]
        
        if len(candidates) > 1:
            await bot.send_message(CHANNEL_ID, "ğŸ¤ ĞĞ¸Ñ‡ÑŒÑ! ĞĞ¸ĞºÑ‚Ğ¾ Ğ½Ğµ Ğ¸Ğ·Ğ³Ğ½Ğ°Ğ½.")
            return True
        
        exiled_id = candidates[0]
        exiled_player = self.players[exiled_id]
        exiled_player["alive"] = False
        
        role_text = {
            "mafia": "ğŸ”« ĞœĞĞ¤Ğ˜Ğ¯",
            "sheriff": "ğŸ‘® Ğ¨Ğ•Ğ Ğ˜Ğ¤", 
            "doctor": "ğŸ’‰ Ğ”ĞĞšĞ¢ĞĞ ",
            "civilian": "ğŸ‘¨â€ğŸŒ¾ ĞœĞ˜Ğ ĞĞ«Ğ™ Ğ–Ğ˜Ğ¢Ğ•Ğ›Ğ¬"
        }
        
        await bot.send_message(
            CHANNEL_ID,
            f"âš–ï¸ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ Ğ“ĞĞ›ĞĞ¡ĞĞ’ĞĞĞ˜Ğ¯:\n\n"
            f"Ğ˜Ğ·Ğ³Ğ½Ğ°Ğ½: {exiled_player['name']}\n"
            f"Ğ Ğ¾Ğ»ÑŒ: {role_text[exiled_player['role']]}"
        )
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ğ¿Ğ¾Ğ±ĞµĞ´Ñ‹
        winner = self.check_win_condition()
        if winner:
            await self.end_game(winner)
            return False
        
        return True
    
    async def end_game(self, winner):
        role_text = {
            "mafia": "ğŸ”« ĞœĞĞ¤Ğ˜Ğ¯",
            "sheriff": "ğŸ‘® Ğ¨Ğ•Ğ Ğ˜Ğ¤",
            "doctor": "ğŸ’‰ Ğ”ĞĞšĞ¢ĞĞ ", 
            "civilian": "ğŸ‘¨â€ğŸŒ¾ ĞœĞ˜Ğ ĞĞ«Ğ™ Ğ–Ğ˜Ğ¢Ğ•Ğ›Ğ¬"
        }
        
        winner_text = "ğŸ”« ĞŸĞĞ‘Ğ•Ğ”Ğ ĞœĞĞ¤Ğ˜Ğ˜!" if winner == "mafia" else "ğŸ‰ ĞŸĞĞ‘Ğ•Ğ”Ğ ĞœĞ˜Ğ ĞĞ«Ğ¥ Ğ–Ğ˜Ğ¢Ğ•Ğ›Ğ•Ğ™!"
        
        # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ¸ Ğ¸Ñ… Ñ€Ğ¾Ğ»ĞµĞ¹
        players_info = "\n".join([
            f"â€¢ {info['name']} - {role_text[info['role']]} {'â˜ ï¸' if not info['alive'] else 'âœ…'}"
            for info in self.players.values()
        ])
        
        await bot.send_message(
            CHANNEL_ID,
            f"ğŸ® Ğ˜Ğ“Ğ Ğ ĞĞšĞĞĞ§Ğ•ĞĞ!\n\n"
            f"{winner_text}\n\n"
            f"ğŸ“Š Ğ˜Ğ¢ĞĞ“Ğ˜:\n{players_info}\n\n"
            f"Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾ Ğ·Ğ° Ğ¸Ğ³Ñ€Ñƒ! ğŸ‰\n"
            f"Ğ”Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ñ‹ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ /start"
        )
        
        global active_game
        active_game = None

# ğŸ¯ ĞšĞĞœĞĞĞ”Ğ /start
@dp.message(Command("start"))
async def start_command(message: types.Message):
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ® ĞŸĞ Ğ˜Ğ¡ĞĞ•Ğ”Ğ˜ĞĞ˜Ğ¢Ğ¬Ğ¡Ğ¯ Ğš Ğ˜Ğ“Ğ Ğ•", callback_data="join_game")],
        [InlineKeyboardButton(text="ğŸ“– ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ˜Ğ“Ğ Ğ«", callback_data="show_rules")],
        [InlineKeyboardButton(text="ğŸ‘¥ Ğ˜Ğ“Ğ ĞĞšĞ˜ Ğ’ Ğ›ĞĞ‘Ğ‘Ğ˜", callback_data="show_players")],
        [InlineKeyboardButton(text="ğŸ“¢ ĞŸĞ•Ğ Ğ•Ğ™Ğ¢Ğ˜ Ğ’ ĞšĞĞĞĞ›", url=f"https://t.me/{CHANNEL_ID[1:]}")]
    ])
    
    await message.answer(
        "ğŸ® Ğ”ĞĞ‘Ğ Ğ ĞŸĞĞ–ĞĞ›ĞĞ’ĞĞ¢Ğ¬ Ğ’ ĞœĞĞ¤Ğ˜Ğ®!\n\n"
        "Ğ¯ Ğ±ÑƒĞ´Ñƒ Ñ‚Ğ²Ğ¾Ğ¸Ğ¼ Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ğ¼ Ğ² ÑÑ‚Ğ¾Ğ¹ Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‰ĞµĞ¹ Ğ¸Ğ³Ñ€Ğµ!\n"
        "Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°Ğ¹ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
        reply_markup=keyboard
    )

# ğŸ¯ ĞŸĞ Ğ˜Ğ¡ĞĞ•Ğ”Ğ˜ĞĞ•ĞĞ˜Ğ• Ğš Ğ˜Ğ“Ğ Ğ•
@dp.callback_query(F.data == "join_game")
async def join_game(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    user_name = callback.from_user.first_name
    
    waiting_players[user_id] = user_name
    players_count = len(waiting_players)
    
    await callback.answer(f"Ğ¢Ñ‹ Ğ² Ğ¸Ğ³Ñ€Ğµ, {user_name}! ğŸ‰")
    await callback.message.edit_text(
        f"âœ… Ğ¢Ğ« Ğ’ Ğ˜Ğ“Ğ Ğ•!\n\n"
        f"ğŸ‘¥ Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ² Ğ»Ğ¾Ğ±Ğ±Ğ¸: {players_count}\n"
        f"ğŸ¯ ĞÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ€Ñ‚Ğ°: 4 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°\n\n"
        f"Ğ–Ğ´ĞµĞ¼ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ…... â³\n\n"
        f"ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ: /start_game"
    )

# ğŸ¯ Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ˜Ğ“Ğ Ğ«
@dp.message(Command("start_game"))
async def start_game_command(message: types.Message):
    global active_game
    
    if active_game:
        await message.answer("âŒ Ğ˜Ğ³Ñ€Ğ° ÑƒĞ¶Ğµ Ğ¸Ğ´ĞµÑ‚! Ğ”Ğ¾Ğ¶Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ¾ĞºĞ¾Ğ½Ñ‡Ğ°Ğ½Ğ¸Ñ.")
        return
        
    if len(waiting_players) < 4:
        await message.answer(f"âŒ ĞÑƒĞ¶Ğ½Ğ¾ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 4 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°. Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ: {len(waiting_players)}")
        return
    
    # Ğ¡ĞĞ—Ğ”ĞĞ•Ğœ ĞĞĞ’Ğ£Ğ® Ğ˜Ğ“Ğ Ğ£
    active_game = MafiaGame()
    
    # Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ˜Ğ“Ğ ĞĞšĞĞ’ Ğ’ Ğ˜Ğ“Ğ Ğ£
    player_list = []
    for user_id, user_name in waiting_players.items():
        active_game.players[user_id] = {
            "name": user_name,
            "role": "",
            "alive": True
        }
        player_list.append(f"â€¢ {user_name}")
    
    # Ğ ĞĞ¡ĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ¯Ğ•Ğœ Ğ ĞĞ›Ğ˜
    roles = active_game.assign_roles(len(waiting_players))
    user_ids = list(active_game.players.keys())
    
    for i, user_id in enumerate(user_ids):
        if i < len(roles):
            active_game.players[user_id]["role"] = roles[i]
    
    # ĞĞ¢ĞŸĞ ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ ĞĞ›Ğ˜ Ğ˜Ğ“Ğ ĞĞšĞĞœ
    await active_game.send_roles()
    
    # ĞĞŸĞĞ’Ğ•Ğ©ĞĞ•Ğœ Ğ’ ĞšĞĞĞĞ›Ğ•
    try:
        await bot.send_message(
            CHANNEL_ID,
            f"ğŸ® Ğ˜Ğ“Ğ Ğ ĞĞĞ§Ğ˜ĞĞĞ•Ğ¢Ğ¡Ğ¯!\n\n"
            f"Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ ({len(waiting_players)} Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²):\n" + "\n".join(player_list) +
            f"\n\nğŸŒ™ ĞĞĞ§Ğ¬ {active_game.day_number}\n"
            f"Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ·Ğ°ÑÑ‹Ğ¿Ğ°ĞµÑ‚... ĞŸÑ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑ Ğ¼Ğ°Ñ„Ğ¸Ñ!"
        )
    except Exception as e:
        print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ² ĞºĞ°Ğ½Ğ°Ğ»: {e}")
    
    # ĞĞ§Ğ˜Ğ©ĞĞ•Ğœ Ğ›ĞĞ‘Ğ‘Ğ˜
    waiting_players.clear()
    
    # Ğ—ĞĞŸĞ£Ğ¡ĞšĞĞ•Ğœ ĞĞĞ§Ğ¬
    asyncio.create_task(run_night_phase())
    
    await message.answer(
        f"ğŸ® Ğ˜Ğ“Ğ Ğ Ğ—ĞĞŸĞ£Ğ©Ğ•ĞĞ!\n\n"
        f"Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸: {len(active_game.players)} Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²\n"
        f"Ğ Ğ¾Ğ»Ğ¸ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹! Ğ˜Ğ³Ñ€Ğ¾ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¸ ÑĞ²Ğ¾Ğ¸ Ñ€Ğ¾Ğ»Ğ¸ Ğ² Ğ›Ğ¡.\n\n"
        f"Ğ¡Ğ»ĞµĞ´Ğ¸Ñ‚Ğµ Ğ·Ğ° Ğ¸Ğ³Ñ€Ğ¾Ğ¹ Ğ² ĞºĞ°Ğ½Ğ°Ğ»Ğµ!"
    )

# ğŸ¯ ĞĞĞ§ĞĞ«Ğ• Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ¯
@dp.callback_query(F.data.startswith("mafia_kill:"))
async def mafia_kill(callback: types.CallbackQuery):
    if not active_game or active_game.phase != "night":
        await callback.answer("âŒ Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ Ğ½Ğ¾Ñ‡ÑŒ!", show_alert=True)
        return
    
    target_id = int(callback.data.split(":")[1])
    player_info = active_game.players.get(callback.from_user.id)
    
    if not player_info or player_info["role"] != "mafia" or not player_info["alive"]:
        await callback.answer("âŒ Ğ¢Ñ‹ Ğ½Ğµ Ğ¼Ğ°Ñ„Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ¼ĞµÑ€Ñ‚Ğ²!", show_alert=True)
        return
    
    night_actions[callback.from_user.id] = ("mafia_kill", target_id)
    target_name = active_game.players[target_id]["name"]
    
    await callback.answer(f" Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ° Ğ¶ĞµÑ€Ñ‚Ğ²Ğ°: {target_name}", show_alert=False)
    await callback.message.edit_text(f"ğŸ”« Ğ¢Ñ‹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ» Ğ¶ĞµÑ€Ñ‚Ğ²Ñƒ: {target_name}")

@dp.callback_query(F.data.startswith("doctor_heal:"))
async def doctor_heal(callback: types.CallbackQuery):
    if not active_game or active_game.phase != "night":
        await callback.answer("âŒ Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ Ğ½Ğ¾Ñ‡ÑŒ!", show_alert=True)
        return
    
    target_id = int(callback.data.split(":")[1])
    player_info = active_game.players.get(callback.from_user.id)
    
    if not player_info or player_info["role"] != "doctor" or not player_info["alive"]:
        await callback.answer("âŒ Ğ¢Ñ‹ Ğ½Ğµ Ğ´Ğ¾ĞºÑ‚Ğ¾Ñ€ Ğ¸Ğ»Ğ¸ Ğ¼ĞµÑ€Ñ‚Ğ²!", show_alert=True)
        return
    
    night_actions[callback.from_user.id] = ("doctor_heal", target_id)
    target_name = active_game.players[target_id]["name"]
    
    await callback.answer(f"ğŸ’‰ Ğ›ĞµÑ‡Ğ¸ÑˆÑŒ: {target_name}", show_alert=False)
    await callback.message.edit_text(f"ğŸ’‰ Ğ¢Ñ‹ Ğ»ĞµÑ‡Ğ¸ÑˆÑŒ: {target_name}")

@dp.callback_query(F.data.startswith("sheriff_check:"))
async def sheriff_check(callback: types.CallbackQuery):
    if not active_game or active_game.phase != "night":
        await callback.answer("âŒ Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ Ğ½Ğ¾Ñ‡ÑŒ!", show_alert=True)
        return
    
    target_id = int(callback.data.split(":")[1])
    player_info = active_game.players.get(callback.from_user.id)
    
    if not player_info or player_info["role"] != "sheriff" or not player_info["alive"]:
        await callback.answer("âŒ Ğ¢Ñ‹ Ğ½Ğµ ÑˆĞµÑ€Ğ¸Ñ„ Ğ¸Ğ»Ğ¸ Ğ¼ĞµÑ€Ñ‚Ğ²!", show_alert=True)
        return
    
    night_actions[callback.from_user.id] = ("sheriff_check", target_id)
    target_name = active_game.players[target_id]["name"]
    
    await callback.answer(f"ğŸ‘® ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑˆÑŒ: {target_name}", show_alert=False)
    await callback.message.edit_text(f"ğŸ‘® Ğ¢Ñ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑˆÑŒ: {target_name}")

# ğŸ¯ Ğ“ĞĞ›ĞĞ¡ĞĞ’ĞĞĞ˜Ğ•
@dp.callback_query(F.data.startswith("vote:"))
async def vote_player(callback: types.CallbackQuery):
    if not active_game or active_game.phase != "day":
        await callback.answer("âŒ Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ Ğ´ĞµĞ½ÑŒ!", show_alert=True)
        return
    
    target_id = int(callback.data.split(":")[1])
    player_info = active_game.players.get(callback.from_user.id)
    
    if not player_info or not player_info["alive"]:
        await callback.answer("âŒ Ğ¢Ñ‹ Ğ¼ĞµÑ€Ñ‚Ğ² Ğ¸ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ñ‚ÑŒ!", show_alert=True)
        return
    
    if target_id == callback.from_user.id:
        await callback.answer("âŒ ĞĞµĞ»ÑŒĞ·Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ° ÑĞµĞ±Ñ!", show_alert=True)
        return
    
    active_game.votes[callback.from_user.id] = target_id
    target_name = active_game.players[target_id]["name"]
    
    await callback.answer(f"ğŸ—³ï¸ Ğ“Ğ¾Ğ»Ğ¾Ñ Ğ·Ğ°: {target_name}", show_alert=False)
    await callback.message.edit_text(f"ğŸ—³ï¸ Ğ¢Ñ‹ Ğ¿Ñ€Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ°Ğ» Ğ·Ğ°: {target_name}")

# ğŸ¯ ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ• Ğ¤ĞĞ—Ğ«
async def run_night_phase():
    await asyncio.sleep(2)  # Ğ”Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‚
    
    if not active_game:
        return
        
    await active_game.start_night()
    await asyncio.sleep(120)  # 2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ Ğ½Ğ° Ğ½Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ
    
    if active_game and active_game.phase == "night":
        continue_game = await active_game.process_night_actions()
        if continue_game:
            await asyncio.sleep(5)
            asyncio.create_task(run_day_phase())

async def run_day_phase():
    if not active_game:
        return
        
    await active_game.start_day()
    await asyncio.sleep(180)  # 3 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹ Ğ½Ğ° Ğ¾Ğ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ
    
    if active_game and active_game.phase == "day":
        continue_game = await active_game.process_voting()
        if continue_game:
            active_game.day_number += 1
            await asyncio.sleep(5)
            asyncio.create_task(run_night_phase())

# ğŸ¯ ĞšĞĞœĞĞĞ”Ğ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡Ğ
@dp.message(Command("game_status"))
async def game_status_command(message: types.Message):
    if not active_game:
        await message.answer("âŒ Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ñ‹")
        return
    
    alive_players = active_game.get_alive_players_info()
    mafia_count = sum(1 for info in alive_players.values() if info["role"] == "mafia")
    civilian_count = len(alive_players) - mafia_count
    
    status_text = (
        f"ğŸ® Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ Ğ˜Ğ“Ğ Ğ«:\n\n"
        f"ğŸ“Š Ğ¤Ğ°Ğ·Ğ°: {'ğŸŒ™ ĞĞĞ§Ğ¬' if active_game.phase == 'night' else 'â˜€ï¸ Ğ”Ğ•ĞĞ¬'} {active_game.day_number}\n"
        f"ğŸ‘¥ Ğ–Ğ¸Ğ²Ñ‹Ñ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²: {len(alive_players)}\n"
        f"ğŸ”« ĞœĞ°Ñ„Ğ¸Ñ: {mafia_count}\n"
        f"ğŸ‘¨â€ğŸŒ¾ ĞœĞ¸Ñ€Ğ½Ñ‹Ğµ: {civilian_count}\n\n"
        f"ğŸ¯ Ğ–Ğ¸Ğ²Ñ‹Ğµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸:\n" + "\n".join([f"â€¢ {info['name']}" for info in alive_players.values()])
    )
    
    await message.answer(status_text)

# ğŸ¯ ĞšĞĞ“Ğ”Ğ ĞĞĞ–Ğ˜ĞœĞĞ®Ğ¢ "ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ Ğ˜Ğ“Ğ Ğ«"
@dp.callback_query(F.data == "show_rules")
async def show_rules(callback: types.CallbackQuery):
    rules_text = (
        "ğŸ“– ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ ĞœĞĞ¤Ğ˜Ğ˜:\n\n"
        "ğŸ¯ Ğ¦Ğ•Ğ›Ğ˜:\n"
        "â€¢ ğŸ”« ĞœĞĞ¤Ğ˜Ğ¯: ÑƒĞ±Ğ¸Ñ‚ÑŒ Ğ²ÑĞµÑ… Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ñ… Ğ¶Ğ¸Ñ‚ĞµĞ»ĞµĞ¹\n"
        "â€¢ ğŸ‘¨â€ğŸŒ¾ ĞœĞ˜Ğ ĞĞ«Ğ•: Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¸ Ğ¸Ğ·Ğ³Ğ½Ğ°Ñ‚ÑŒ Ğ²ÑÑ Ğ¼Ğ°Ñ„Ğ¸Ñ\n\n"
        "ğŸŒ™ ĞĞĞ§ĞĞĞ¯ Ğ¤ĞĞ—Ğ:\n"
        "â€¢ ĞœĞ°Ñ„Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑ Ğ¸ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¶ĞµÑ€Ñ‚Ğ²Ñƒ\n"
        "â€¢ Ğ”Ğ¾ĞºÑ‚Ğ¾Ñ€ Ğ»ĞµÑ‡Ğ¸Ñ‚ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°\n"
        "â€¢ Ğ¨ĞµÑ€Ğ¸Ñ„ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ñ€Ğ¾Ğ»ÑŒ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°\n\n"
        "â˜€ï¸ Ğ”ĞĞ•Ğ’ĞĞĞ¯ Ğ¤ĞĞ—Ğ:\n"
        "â€¢ Ğ’ÑĞµ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¸ Ğ¾Ğ±ÑÑƒĞ¶Ğ´Ğ°ÑÑ‚ Ğ¸ Ğ²Ñ‹Ğ´Ğ²Ğ¸Ğ³Ğ°ÑÑ‚ Ğ²ĞµÑ€ÑĞ¸Ğ¸\n"
        "â€¢ Ğ“Ğ¾Ğ»Ğ¾ÑÑƒÑÑ‚ Ğ·Ğ° Ğ¸Ğ·Ğ³Ğ½Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€ĞµĞ²Ğ°ĞµĞ¼Ğ¾Ğ³Ğ¾\n"
        "â€¢ Ğ˜Ğ·Ğ³Ğ½Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğº Ñ€Ğ°ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ²Ğ¾Ñ Ñ€Ğ¾Ğ»ÑŒ\n\n"
        "âš–ï¸ Ğ£Ğ¡Ğ›ĞĞ’Ğ˜Ğ¯ ĞŸĞĞ‘Ğ•Ğ”Ğ«:\n"
        "â€¢ ĞœĞ°Ñ„Ğ¸Ñ Ğ¿Ğ¾Ğ±ĞµĞ¶Ğ´Ğ°ĞµÑ‚, ĞºĞ¾Ğ³Ğ´Ğ° Ğ¸Ñ… Ñ‡Ğ¸ÑĞ»Ğ¾ >= Ğ¼Ğ¸Ñ€Ğ½Ñ‹Ñ…\n"
        "â€¢ ĞœĞ¸Ñ€Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ±ĞµĞ¶Ğ´Ğ°ÑÑ‚, ĞºĞ¾Ğ³Ğ´Ğ° Ğ²ÑÑ Ğ¼Ğ°Ñ„Ğ¸Ñ Ğ¸Ğ·Ğ³Ğ½Ğ°Ğ½Ğ°\n\n"
        "ğŸ‘¤ Ğ ĞĞ›Ğ˜:\n"
        "â€¢ ğŸ”« ĞœĞĞ¤Ğ˜Ğ¯ (1-3): ÑƒĞ±Ğ¸Ğ²Ğ°ÑÑ‚ Ğ½Ğ¾Ñ‡ÑŒÑ, ÑĞºÑ€Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ´Ğ½ĞµĞ¼\n"
        "â€¢ ğŸ‘® Ğ¨Ğ•Ğ Ğ˜Ğ¤ (1): Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ¾Ñ‡ÑŒÑ\n"
        "â€¢ ğŸ’‰ Ğ”ĞĞšĞ¢ĞĞ  (1): Ğ»ĞµÑ‡Ğ¸Ñ‚ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ½Ğ¾Ñ‡ÑŒÑ\n"
        "â€¢ ğŸ‘¨â€ğŸŒ¾ ĞœĞ˜Ğ ĞĞ«Ğ• (2+): Ğ¸Ñ‰ÑƒÑ‚ Ğ¼Ğ°Ñ„Ğ¸Ñ, Ğ³Ğ¾Ğ»Ğ¾ÑÑƒÑÑ‚ Ğ´Ğ½ĞµĞ¼"
    )
    await callback.answer(rules_text, show_alert=True)

@dp.callback_query(F.data == "show_players")
async def show_players(callback: types.CallbackQuery):
    if not waiting_players:
        players_list = "ĞŸĞ¾ĞºĞ° Ğ½Ğ¸ĞºĞ¾Ğ³Ğ¾ Ğ½ĞµÑ‚ ğŸ˜”"
    else:
        players_list = "\n".join([f"â€¢ {name}" for name in waiting_players.values()])
    
    total_players = len(waiting_players)
    await callback.answer(f"ğŸ‘¥ Ğ˜Ğ“Ğ ĞĞšĞ˜ Ğ’ Ğ›ĞĞ‘Ğ‘Ğ˜:\n\n{players_list}\n\nĞ’ÑĞµĞ³Ğ¾: {total_players}", show_alert=True)

# ğŸš€ Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ‘ĞĞ¢Ğ
async def main():
    logging.basicConfig(level=logging.INFO)
    print("ğŸ® Ğ‘Ğ¾Ñ‚ ĞœĞ°Ñ„Ğ¸Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ...")
    print(f"ğŸ“¢ ĞšĞ°Ğ½Ğ°Ğ»: {CHANNEL_ID}")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())